<!DOCTYPE html>
<html lang="en">
  <head>
    <title>209490 &ndash; Put purging mechanism in CDOViewIMpl::objects to avoid OutOfMemory</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link href="https://bugs.eclipse.org/bugs/data/assets/03c4bb46b12126a79867f9a9f5323634.css?1593441374" rel="stylesheet" type="text/css">



    
<script type="text/javascript" src="https://bugs.eclipse.org/bugs/data/assets/a7c2f3a028f17a9aa60f56dc9d6e732d.js?1593441374"></script>

    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        YAHOO.util.Event.addListener = function (el, sType, fn, obj, overrideContext) {
               if ( ("onpagehide" in window || YAHOO.env.ua.gecko) && sType === "unload") { sType = "pagehide"; };
               var capture = ((sType == "focusin" || sType == "focusout") && !YAHOO.env.ua.ie) ? true : false;
               return this._addListener(el, this._getType(sType), fn, obj, overrideContext, capture);
         };
        if ( "onpagehide" in window || YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        function unhide_language_selector() { 
            YAHOO.util.Dom.removeClass(
                'lang_links_container', 'bz_default_hidden'
            ); 
        } 
        YAHOO.util.Event.onDOMReady(unhide_language_selector);

        
        var BUGZILLA = {
            param: {
                cookiepath: '\/bugs',
                maxusermatches: 10
            },
            constant: {
                COMMENT_COLS: 80
            },
            string: {
                

                attach_desc_required:
                    "You must enter a Description for this attachment.",
                component_required:
                    "You must select a Component for this bug.",
                description_required:
                    "You must enter a Description for this bug.",
                short_desc_required:
                    "You must enter a Summary for this bug.",
                version_required:
                    "You must select a Version for this bug."
            }
              , api_token: ''
        };

    if (history && history.replaceState) {
      if(!document.location.href.match(/show_bug\.cgi/)) {
        history.replaceState( null,
                             "209490 – Put purging mechanism in CDOViewIMpl::objects to avoid OutOfMemory",
                             "show_bug.cgi?id=209490" );
        document.title = "209490 – Put purging mechanism in CDOViewIMpl::objects to avoid OutOfMemory";
      }
      if (document.location.href.match(/show_bug\.cgi\?.*list_id=/)) {
        var href = document.location.href;
        href = href.replace(/[\?&]+list_id=(\d+|cookie)/, '');
        history.replaceState(null, "209490 – Put purging mechanism in CDOViewIMpl::objects to avoid OutOfMemory", href);
      }
    }
    YAHOO.util.Event.onDOMReady(function() {
      initDirtyFieldTracking();

    });
    // -->
    </script>
<script type="text/javascript" src="https://bugs.eclipse.org/bugs/data/assets/daf5e0fb6826e6a35280e622913f0c4a.js?1593441374"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico">
  </head>

  <body 
        class="bugs-eclipse-org-bugs
                 bz_bug
                 bz_status_CLOSED
                 bz_product_EMF
                 bz_component_cdo.core
                 bz_bug_209490 yui-skin-sam">

  <div id="header"><!-- 1.0@bugzilla.org -->





<!--  START OF SOLSTICE HEADER -->
 <link rel="stylesheet" type="text/css" href="https://www.eclipse.org/eclipse.org-common/themes/solstice/public/stylesheets/vendor/cookieconsent/cookieconsent.min.css" />
 <script src="https://www.eclipse.org/eclipse.org-common/themes/solstice/public/javascript/vendor/cookieconsent/default.min.js"></script>
 <style type="text/css">
    @import url('https://www.eclipse.org/eclipse.org-common/themes/solstice/public/stylesheets/barebone.min.css')
    </style>
    <script
      src="https://www.eclipse.org/eclipse.org-common/themes/solstice/public/javascript/barebone.min.js">
    </script><header role="banner" class="barebone-layout thin-header padding-top-5 padding-bottom-5"  id="header-wrapper">
  <div class="container-fluid reset">
    <div class="row-fluid" id="header-row">
            <div class="col-sm-8 col-md-6 col-lg-4" id="header-left">
        <div class="wrapper-logo-default"><a href="https://www.eclipse.org/"><img class="logo-eclipse-default img-responsive hidden-xs" alt="logo" src="https://bugs.eclipse.org/eclipse.org-common/themes/solstice/public/images/logo/eclipse-426x100.png"/></a></div>
      </div>            <div class="col-sm-16 col-md-18 col-lg-20" id="main-menu-wrapper">
  <div class="navbar yamm" id="main-menu">
    <div id="navbar-collapse-1" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li class="visible-thin"><a href="https://www.eclipse.org/downloads/" target="_self">Download</a></li><li><a href="https://www.eclipse.org/users/" target="_self">Getting Started</a></li><li><a href="https://www.eclipse.org/membership/" target="_self">Members</a></li><li><a href="https://www.eclipse.org/projects/" target="_self">Projects</a></li>                  <li class="dropdown visible-xs"><a href="#" data-toggle="dropdown" class="dropdown-toggle">Community <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="http://marketplace.eclipse.org">Marketplace</a></li><li><a href="http://events.eclipse.org">Events</a></li><li><a href="http://www.planeteclipse.org/">Planet Eclipse</a></li><li><a href="https://www.eclipse.org/community/eclipse_newsletter/">Newsletter</a></li><li><a href="https://www.youtube.com/user/EclipseFdn">Videos</a></li></ul></li><li class="dropdown visible-xs"><a href="#" data-toggle="dropdown" class="dropdown-toggle">Participate <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="https://bugs.eclipse.org/bugs/">Report a Bug</a></li><li><a href="https://www.eclipse.org/forums/">Forums</a></li><li><a href="https://www.eclipse.org/mail/">Mailing Lists</a></li><li><a href="https://wiki.eclipse.org/">Wiki</a></li><li><a href="https://wiki.eclipse.org/IRC">IRC</a></li><li><a href="https://www.eclipse.org/contribute/">How to Contribute</a></li></ul></li><li class="dropdown visible-xs"><a href="#" data-toggle="dropdown" class="dropdown-toggle">Working Groups <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="http://wiki.eclipse.org/Auto_IWG">Automotive</a></li><li><a href="http://iot.eclipse.org">Internet of Things</a></li><li><a href="http://locationtech.org">LocationTech</a></li><li><a href="http://lts.eclipse.org">Long-Term Support</a></li><li><a href="http://polarsys.org">PolarSys</a></li><li><a href="http://science.eclipse.org">Science</a></li><li><a href="http://www.openmdm.org">OpenMDM</a></li></ul></li>          <!-- More -->
          <li class="dropdown eclipse-more hidden-xs">
            <a data-toggle="dropdown" class="dropdown-toggle">More<b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li>
                <!-- Content container to add padding -->
                <div class="yamm-content">
                  <div class="row">
                    <ul class="col-sm-8 list-unstyled"><li><p><strong>Community</strong></p></li><li><a href="http://marketplace.eclipse.org">Marketplace</a></li><li><a href="http://events.eclipse.org">Events</a></li><li><a href="http://www.planeteclipse.org/">Planet Eclipse</a></li><li><a href="https://www.eclipse.org/community/eclipse_newsletter/">Newsletter</a></li><li><a href="https://www.youtube.com/user/EclipseFdn">Videos</a></li></ul><ul class="col-sm-8 list-unstyled"><li><p><strong>Participate</strong></p></li><li><a href="https://bugs.eclipse.org/bugs/">Report a Bug</a></li><li><a href="https://www.eclipse.org/forums/">Forums</a></li><li><a href="https://www.eclipse.org/mail/">Mailing Lists</a></li><li><a href="https://wiki.eclipse.org/">Wiki</a></li><li><a href="https://wiki.eclipse.org/IRC">IRC</a></li><li><a href="https://www.eclipse.org/contribute/">How to Contribute</a></li></ul><ul class="col-sm-8 list-unstyled"><li><p><strong>Working Groups</strong></p></li><li><a href="http://wiki.eclipse.org/Auto_IWG">Automotive</a></li><li><a href="http://iot.eclipse.org">Internet of Things</a></li><li><a href="http://locationtech.org">LocationTech</a></li><li><a href="http://lts.eclipse.org">Long-Term Support</a></li><li><a href="http://polarsys.org">PolarSys</a></li><li><a href="http://science.eclipse.org">Science</a></li><li><a href="http://www.openmdm.org">OpenMDM</a></li></ul>                  </div>
                </div>
              </li>
            </ul>
          </li>
              </ul>
    </div>
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      </button>
      <div class="wrapper-logo-mobile"><a class="navbar-brand visible-xs" href="https://www.eclipse.org/"><img class="logo-eclipse-default-mobile img-responsive" alt="logo" src="https://bugs.eclipse.org/eclipse.org-common/themes/solstice/public/images/logo/eclipse-800x188.png"/></a></div>    </div>
  </div>
</div>
    </div>
  </div>
</header>
<!--  END OF SOLSTICE HEADER -->

    <div id="titles">
      <span id="title">Bugzilla &ndash; Bug&nbsp;209490</span>

        <span id="subtitle" class="subheader">Put purging mechanism in CDOViewIMpl::objects to avoid OutOfMemory</span>

        <span id="information" class="header_addl_info">Last modified: 2010-06-29 09:22:04 EDT</span>
    </div>


    <div id="common_links"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_top" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_top");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_top"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li>
      <span class="separator">| </span>
        <a href="request.cgi">Requests</a></li>


  <li>
        <span class="separator">| </span>
        <a href="https://bugzilla.readthedocs.org/en/5.0/using/understanding.html" target="_blank">Help</a>
      </li>
    

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="show_bug.cgi?id=209490&amp;GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>

  <form action="show_bug.cgi?id=209490" method="POST"
        class="mini_login bz_default_hidden"
        id="mini_login_top">
    <input id="Bugzilla_login_top" required
           name="Bugzilla_login" class="bz_login"
        placeholder="Login">
    <input class="bz_password" name="Bugzilla_password" type="password"
           id="Bugzilla_password_top" required
           placeholder="Password">
    <input type="hidden" name="Bugzilla_login_token"
           value="">
    <input type="submit" name="GoAheadAndLogIn" value="Log in"
            id="log_in_top">
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>
  <span class="separator">| </span>
  <li><a href="http://www.eclipse.org/legal/termsofuse.php">Terms of Use</a></li>
  <span class="separator">| </span>
  <li><a href="http://www.eclipse.org/legal/copyright.php">Copyright Agent</a></li>
</ul>
    </div>
  </div>

  <div id="bugzilla-body">


<script type="text/javascript">
<!--

//-->
</script>

<form name="changeform" id="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2010-06-29 09:22:04">
  <input type="hidden" name="id" value="209490">
  <input type="hidden" name="token" value="1629862183-DcQwKkMZVuciWeWPMz47J4pCZvbvAN-oa1hPEfyQVgA">
<div class="bz_short_desc_container edit_form">
     <a href="show_bug.cgi?id=209490"><b>Bug&nbsp;209490</b></a> <span id="summary_container" class="bz_default_hidden">
      - <span id="short_desc_nonedit_display">Put purging mechanism in CDOViewIMpl::objects to avoid OutOfMemory</span>
     </span>

    <div id="summary_input"><span class="field_label "
    id="field_label_short_desc">


  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
      href="page.cgi?id=fields.html#short_desc"
  >Summary:</a>

</span>Put purging mechanism in CDOViewIMpl::objects to avoid OutOfMemory
    </div>
  </div>
  <script type="text/javascript">
    hideEditableField('summary_container',
                      'summary_input',
                      'summary_edit_action',
                      'short_desc',
                      'Put purging mechanism in CDOViewIMpl::objects to avoid OutOfMemory' );
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <th class="field_label">
      <a href="page.cgi?id=fields.html#bug_status">Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">CLOSED
          FIXED
      </span>
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_alias">


  <a 
      title="A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla."
      class="field_help_link"
      href="page.cgi?id=fields.html#alias"
  >Alias:</a>

</th>
    <td>
        None
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components. Select a Classification to narrow down this list."
      class="field_help_link"
      href="describecomponents.cgi"
  >Product:</a>

</th>
  <td class="field_value "
      id="field_container_product" >EMF

</td>
    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
      href="page.cgi?id=fields.html#classification"
  >Classification:</a>

</th>
  <td class="field_value "
      id="field_container_classification" >Modeling

</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
      href="describecomponents.cgi?product=EMF"
  >Component:</a>

</th>
  <td class="field_value "
      id="field_container_component" >cdo.core

  (<a href="buglist.cgi?component=cdo.core&amp;product=EMF&amp;bug_status=__open__"
      target="_blank">show other bugs</a>)
</td>
    </tr>
    <tr><th class="field_label "
    id="field_label_version">


  <a 
      title="The version field defines the version of the software the bug was found in."
      class="field_help_link"
      href="page.cgi?id=fields.html#version"
  >Version:</a>

</th>

      <td>1.0 &#160; <a href="https://dev.eclipse.org/committers/bugs/bugz_manager.php"><img src="//dev.eclipse.org/small_icons/apps/accessories-text-editor.png" alt="Edit" title="Edit these values" /></a></td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">


  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
      href="page.cgi?id=fields.html#rep_platform"
  >Hardware:</a>

</th>
      <td class="field_value">PC
        Windows XP
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <th class="field_label">
        <label  accesskey="i">
          <a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></label>:
      </th>
      <td>P3
       normal<span id="votes_container">
    (<a href="page.cgi?id=voting/user.html&amp;bug_id=209490#vote_209490">vote</a>)
  </span>
      </td>
    </tr>

      <tr><th class="field_label "
    id="field_label_target_milestone">


  <a 
      title="The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it."
      class="field_help_link"
      href="page.cgi?id=fields.html#target_milestone"
  >Target Milestone:</a>

</th>
        <td>--- &#160; <a href="https://dev.eclipse.org/committers/bugs/bugz_manager.php"><img src="//dev.eclipse.org/small_icons/apps/accessories-text-editor.png" alt="Edit" title="Edit these values" /></a></td>
      </tr>
          
          <tr><th class="field_label "
    id="field_label_assigned_to">


  <a 
      title="The person in charge of resolving the bug."
      class="field_help_link"
      href="page.cgi?id=fields.html#assigned_to"
  >Assignee:</a>

</th>
      <td><span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
      </td>
    </tr>

    <tr><th class="field_label "
    id="field_label_qa_contact">


  <a 
      title="The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#qa_contact"
  >QA Contact:</a>

</th>
      <td><span class="vcard">
</span>
      </td>
    </tr>
    <script type="text/javascript">
      assignToDefaultOnChange(['product', 'component'],
        'emf.cdo-inbox\x40eclipse.org',
        '');
    </script>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_bug_file_loc">


  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
      href="page.cgi?id=fields.html#bug_file_loc"
  >URL:</a>

</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>

    <tr><th class="field_label "
    id="field_label_status_whiteboard">


  <a 
      title="Each bug has a free-form single line text entry box for adding tags and status information."
      class="field_help_link"
      href="page.cgi?id=fields.html#status_whiteboard"
  >Whiteboard:</a>

</th><td>  
  </td>
    </tr>

    <tr><th class="field_label "
    id="field_label_keywords">


  <a 
      title="You can add keywords from a defined list to bugs, in order to easily identify and group them."
      class="field_help_link"
      href="describekeywords.cgi"
  >Keywords:</a>

</th>
  <td class="field_value "
      id="field_container_keywords" >

</td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>

          
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#dependson"
  >Depends on:</a>

</th>

  <td>
    <span id="dependson_input_area">
    </span>

  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#blocked"
  >Blocks:</a>

</th>

  <td>
    <span id="blocked_input_area">
    </span>

  </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table>
        <tr>
    <th class="field_label">
      Reported:
    </th>
    <td>2007-11-12 09:04 EST by <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      Modified:
    </th>
    <td>2010-06-29 09:22 EDT
      (<a href="show_activity.cgi?id=209490">History</a>)
    </td>
  
  </tr>
<tr>
      <th class="field_label">
        <label  accesskey="a">
          CC List:
        </label>
      </th>
      <td>1 
          user
          <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
            (<a href="#" id="cc_edit_area_showhide">show</a>)
          </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" multiple="multiple" size="5" >
                <option value="stepper">stepper</option>
            </select>
        </div>
          <script type="text/javascript">
            hideEditableField( 'cc_edit_area_showhide_container', 
                               'cc_edit_area', 
                               'cc_edit_area_showhide', 
                               '', 
                               '');  
          </script>
      </td>
    </tr>

<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_see_also">


  <a 
      title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields."
      class="field_help_link"
      href="page.cgi?id=fields.html#see_also"
  >See Also:</a>

</th>
  <td class="field_value "
      id="field_container_see_also" >

</td>
    </tr> 

<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>



        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts">
  <tr>
  <td>

    
<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    var view_all = document.getElementById("view_all");
    var hide_obsolete_url_parameter = "&hide_obsolete=1";
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
        view_all.href = view_all.href + hide_obsolete_url_parameter 
    }
    else {
        link.innerHTML = "Hide Obsolete";
        view_all.href = view_all.href.replace(hide_obsolete_url_parameter,"");
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table">
  <tr id="a0">
    <th colspan="3" class="left">
      Attachments
    </th>
  </tr>


      <tr id="a1" class="bz_contenttype_text_plain">
        <td>
            <a href="attachment.cgi?id=85455"
               title="View the content of the attachment">
          <b>a testcase to show the problem.</b></a>

          <span class="bz_attach_extra_info">
              (1.54 KB,
                text/plain)

            <br>
            <a href="#attach_85455"
               title="Go to the comment associated with the attachment">2007-12-18 07:33 EST</a>,

            <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
          </span>
        </td>

          <td class="bz_attach_flags">
              <i>no flags</i>
          </td>

        <td>
          <a href="attachment.cgi?id=85455&amp;action=edit">Details</a>
        </td>
      </tr>
      <tr id="a2" class="bz_contenttype_text_plain">
        <td>
            <a href="attachment.cgi?id=85456"
               title="View the content of the attachment">
          <b>2 test cases plus a fix to show the fix</b></a>

          <span class="bz_attach_extra_info">
              (2.96 KB,
                text/plain)

            <br>
            <a href="#attach_85456"
               title="Go to the comment associated with the attachment">2007-12-18 07:41 EST</a>,

            <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
          </span>
        </td>

          <td class="bz_attach_flags">
              <i>no flags</i>
          </td>

        <td>
          <a href="attachment.cgi?id=85456&amp;action=edit">Details</a>
        </td>
      </tr>

  <tr class="bz_attach_footer">
    <td colspan="3">
        <span class="bz_attach_view_hide">
            <a id="view_all" href="attachment.cgi?bugid=209490&amp;action=viewall">View All</a>
        </span>
        <a href="attachment.cgi?bugid=209490&amp;action=enter">Add an attachment</a>
        (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>
<div id="add_comment" class="bz_section_additional_comments">
      <table>
        <tr>
          <td>
            <fieldset>
              <legend>Note</legend>
              You need to
              <a href="show_bug.cgi?id=209490&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </fieldset>
          </td>
        </tr> 
      </table>
  </div>
  </td>
  <td>
  </td>
  </tr></table>

  
  <div id="comments"><script src="https://bugs.eclipse.org/bugs/js/comments.js?1463425338" type="text/javascript">
</script>

<script type="text/javascript">
<!--
  /* Adds the reply text to the 'comment' textarea */
  function replyToComment(id, real_id, name) {
      var prefix = "(In reply to " + name + " from comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);
        replytext = prefix + wrapReplyText(text);


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      if (textarea.value != replytext) {
          textarea.value += replytext;
      }

      textarea.focus();
  } 
//-->
</script>


<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table">
<tr>
<td>
<div id="c0" class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c0">Description</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-12 09:04:33 EST
        </span>

      </div>




<pre class="bz_comment_text">We put purging mechanisms for objects in CDORevisionResolver. WIll be good to have the same concept in CDOViewImpl since we never purge that HashMap and it can causesus problem.</pre>
    </div>

    <div id="c1" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-13 02:21:10 EST
        </span>

      </div>




<pre class="bz_comment_text">Do you agree that, other than in (server-side) RevisionManager, we need a memory sensitive cache without special eviction policy here?</pre>
    </div>

    <div id="c2" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-13 07:13:46 EST
        </span>

      </div>




<pre class="bz_comment_text">This is an interesting question.

Before answering I would like to ask you a question.

CDORevisionResolverImpl have a list of CDORevision. CDORevisionResolverImpl have a list of InternalCDOObject that once we load it refer to a CDORevision.

Does the eviction of CDORevisionResolverImpl::objects takes that in parameters ? In the sense that it will not evict an CDORevision that still have reference to him. (If no, we could have a problem)

If it does, this mean that we only need a memory sensitive cache. We could put a SoftMap... and that's it.

If it doesn't, I see that CDOViewImpl could refer to CDORevision that are not there anymore... I'm not sure if I like that ?

In brief, if by affecting the size of CDORevisionResolverImpl ALWAYS affect the size of every CDOVIewImpl... yes we don't need it.

Otherwise you could want CDOVIewImpl smaller than other etc.

In my opinion, the way you evict yourobjects should be a strategy... one would be memory... we could use other strategy.. it doesn't matter. 

I would like to control my CDOViewImpl in the sense that I want to have this specific CDOViewImpl as small as possible... the other bigger.. etc.. etc.. 
If I use too much memory the strategy that evict objects base on memory will kick in. It will evict ONLY objects that are not referenced by the application.

What you think ?
</pre>
    </div>

    <div id="c3" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-13 07:35:35 EST
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=209490#c2">comment #2</a>)
<span class="quote">&gt; CDORevisionResolverImpl have a list of CDORevision. CDORevisionResolverImpl
&gt; have a list of InternalCDOObject that once we load it refer to a CDORevision.</span >

CDORevisionResolverImpl has two lists of CDORevisionHolder which in turn point to CDORevision each (and to other CDORevisionHolders to enable the various access methods).

In particular a CDORevision (or anything else defined in the .protocol plugin) will never point to an InternalCDOObject (or anything defined in the .cdo plugin).

<span class="quote">&gt; Does the eviction of CDORevisionResolverImpl::objects takes that in parameters
&gt; ? In the sense that it will not evict an CDORevision that still have reference
&gt; to him. (If no, we could have a problem)</span >

Hmm, I will have to check that. Can well be the case that we have that situation. But I'm not sure yet if that would really indicate a problem!

<span class="quote">&gt; If it does, this mean that we only need a memory sensitive cache. We could put
&gt; a SoftMap... and that's it.</span >

Basically I prefer to use ConcurrentHashMap+ReferenceQueue but we'll see ;-)
In any event it'd be good to make the creation of the cache overrideable.

<span class="quote">&gt; If it doesn't, I see that CDOViewImpl could refer to CDORevision that are not
&gt; there anymore... I'm not sure if I like that ?</span >

To be exact, CDOViewImpl could refer to a CDORevision that is still there but no longer contained in RevisionResolverImpl. As I said above I'm not sure if this is really a problem since the revisions are by definition not linked with anything themselves.

<span class="quote">&gt; In brief, if by affecting the size of CDORevisionResolverImpl ALWAYS affect the
&gt; size of every CDOVIewImpl... yes we don't need it.
&gt; 
&gt; Otherwise you could want CDOVIewImpl smaller than other etc.
&gt; 
&gt; In my opinion, the way you evict yourobjects should be a strategy... one would
&gt; be memory... we could use other strategy.. it doesn't matter. 
&gt; 
&gt; I would like to control my CDOViewImpl in the sense that I want to have this
&gt; specific CDOViewImpl as small as possible... the other bigger.. etc.. etc.. 
&gt; If I use too much memory the strategy that evict objects base on memory will
&gt; kick in. It will evict ONLY objects that are not referenced by the application.
&gt; 
&gt; What you think ?</span >

I think the main difference (here) between CDOObject (cached in CDOView) and CDORevision (cached in CDORevisionResolver) is that the revisions are shared by multiple CDOObjects but the CDOObjects are only used by the application. Consequently I tend to use a memory sensitive cache (without special eviction policy). When the objects are no longer referenced by the application they can certainly disappear, when they are still referenced they can certainly not appear. If there are too many objects in the view cache (all referenced by the application) then buying more memory is the oly option ;-)</pre>
    </div>

    <div id="c4" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-13 07:58:50 EST
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=209490#c3">comment #3</a>)
<span class="quote">&gt; (In reply to <a href="show_bug.cgi?id=209490#c2">comment #2</a>)
&gt; &gt; CDORevisionResolverImpl have a list of CDORevision. CDORevisionResolverImpl
&gt; &gt; have a list of InternalCDOObject that once we load it refer to a CDORevision.
&gt; CDORevisionResolverImpl has two lists of CDORevisionHolder which in turn point
&gt; to CDORevision each (and to other CDORevisionHolders to enable the various
&gt; access methods).
&gt; In particular a CDORevision (or anything else defined in the .protocol plugin)
&gt; will never point to an InternalCDOObject (or anything defined in the .cdo
&gt; plugin).
&gt; &gt; Does the eviction of CDORevisionResolverImpl::objects takes that in parameters
&gt; &gt; ? In the sense that it will not evict an CDORevision that still have reference
&gt; &gt; to him. (If no, we could have a problem)
&gt; Hmm, I will have to check that. Can well be the case that we have that
&gt; situation. But I'm not sure yet if that would really indicate a problem!</span >

The problem I can see is that we could evict objects for nothings...Why would we evict an object to have more memory that doesn't free any memory. Useless ? In this case it will react as before.

Probably for a stability point of view it will work fine. I know some of our algorithm (ReadAhead- Analyzer) uses CDORevisionResolverImpl::containsRevision to determine their cost to get 1 specific object or to see if someone have it. In this specific case... it will have wrong assumptions.. because in fact it is still in memory somewhere except that it is not available. 
The cost to not do it will be performance... and problem in the future. 

In the other case, It really need to be clear in the doc that CDOViewImpl could refer to an object that it's representation isn't necessarly in the CDOSessionImpl (through CDORevisionResolverImpl). 


<span class="quote">&gt; &gt; If it does, this mean that we only need a memory sensitive cache. We could put
&gt; &gt; a SoftMap... and that's it.
&gt; Basically I prefer to use ConcurrentHashMap+ReferenceQueue but we'll see ;-)
&gt; In any event it'd be good to make the creation of the cache overrideable.
&gt; &gt; If it doesn't, I see that CDOViewImpl could refer to CDORevision that are not
&gt; &gt; there anymore... I'm not sure if I like that ?
&gt; To be exact, CDOViewImpl could refer to a CDORevision that is still there but
&gt; no longer contained in RevisionResolverImpl. As I said above I'm not sure if
&gt; this is really a problem since the revisions are by definition not linked with
&gt; anything themselves.
&gt; &gt; In brief, if by affecting the size of CDORevisionResolverImpl ALWAYS affect the
&gt; &gt; size of every CDOVIewImpl... yes we don't need it.
&gt; &gt; 
&gt; &gt; Otherwise you could want CDOVIewImpl smaller than other etc.
&gt; &gt; 
&gt; &gt; In my opinion, the way you evict yourobjects should be a strategy... one would
&gt; &gt; be memory... we could use other strategy.. it doesn't matter. 
&gt; &gt; 
&gt; &gt; I would like to control my CDOViewImpl in the sense that I want to have this
&gt; &gt; specific CDOViewImpl as small as possible... the other bigger.. etc.. etc.. 
&gt; &gt; If I use too much memory the strategy that evict objects base on memory will
&gt; &gt; kick in. It will evict ONLY objects that are not referenced by the application.
&gt; &gt; 
&gt; &gt; What you think ?
&gt; I think the main difference (here) between CDOObject (cached in CDOView) and
&gt; CDORevision (cached in CDORevisionResolver) is that the revisions are shared by
&gt; multiple CDOObjects but the CDOObjects are only used by the application.
&gt; Consequently I tend to use a memory sensitive cache (without special eviction
&gt; policy). When the objects are no longer referenced by the application they can
&gt; certainly disappear, when they are still referenced they can certainly not
&gt; appear. If there are too many objects in the view cache (all referenced by the
&gt; application) then buying more memory is the oly option ;-)</span >

</pre>
    </div>

    <div id="c5" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-13 08:14:53 EST
        </span>

      </div>




<pre class="bz_comment_text">I can see the point and basically I don't like it very much that CDOObject refers to a revision that is no longer in the revision cache. May be it's not a stability problem today but what if I change something and don't remember?! Hard to provide tests cases to prevent this from happening.

Another disadvantage of the current approach in RevisionManager is that revisions can be discarded although plenty of mem is still available. But, as you might remember, the following things are impossible at the same time:
1) Have a memory sensitive cache (--&gt; maximum memory utilization)
2) Have a configurable eviction policy (--&gt; minimum reconstruction penalty)

If you can *proof* that wrong I'd be glad and open for patches ;-)

</pre>
    </div>

    <div id="c6" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-13 09:14:14 EST
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=209490#c5">comment #5</a>)
<span class="quote">&gt; I can see the point and basically I don't like it very much that CDOObject
&gt; refers to a revision that is no longer in the revision cache. May be it's not a
&gt; stability problem today but what if I change something and don't remember?!
&gt; Hard to provide tests cases to prevent this from happening.
&gt; Another disadvantage of the current approach in RevisionManager is that
&gt; revisions can be discarded although plenty of mem is still available. But, as
&gt; you might remember, the following things are impossible at the same time:
&gt; 1) Have a memory sensitive cache (--&gt; maximum memory utilization)
&gt; 2) Have a configurable eviction policy (--&gt; minimum reconstruction penalty)
&gt; If you can *proof* that wrong I'd be glad and open for patches ;-)</span >

To have both and to keep the integrity of ours objects we use 2 maps.

It is why we used WeakHashMap. If we used only a WeakHashMap (I don't propose that I just start from there)... We will only have in our hashMap what it is referenced. 
We need to add another mechanisms to not automatically garbage collect these objects. We can use one LRU or something else.

You always lookup in the WeakHashMap. The other structure is use based on your strategy.

I can build a small example tonight if you want to see the concept.. the design will probably not work with RevisionHOlder... but just an example of 
EvictMap that have both of them (memory and Maximum of objects).







</pre>
    </div>

    <div id="c7" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-13 14:33:03 EST
        </span>

      </div>




<pre class="bz_comment_text">I'd be great if you could come up with a tiny code illustration ;-)</pre>
    </div>

    <div id="c8" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-15 03:08:34 EST
        </span>

      </div>




<pre class="bz_comment_text">One note to the usage of WeakHashMap: I don't think that we can use such to implement a meory sensitive cache of InteralCDOObjects. We need a Map with weak (better soft) refs to the values and not to the keys. Agreed?

</pre>
    </div>

    <div id="c9" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-15 07:04:23 EST
        </span>

      </div>




<pre class="bz_comment_text">One note to the usage of WeakHashMap: I don't think that we can use such to implement a meory sensitive cache of InteralCDOObjects. We need a Map with weak (better soft) refs to the values and not to the keys. Agreed?

</pre>
    </div>

    <div id="c10" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-15 07:05:13 EST
        </span>

      </div>




<pre class="bz_comment_text">Committed to CVS.

Simon: Can you please have a look if you like the current implementation of ReferenceValueMap?</pre>
    </div>

    <div id="c11" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c11">Comment 11</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-15 07:15:45 EST
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=209490#c9">comment #9</a>)
<span class="quote">&gt; One note to the usage of WeakHashMap: I don't think that we can use such to
&gt; implement a meory sensitive cache of InteralCDOObjects. We need a Map with weak
&gt; (better soft) refs to the values and not to the keys. Agreed?</span >

I do not agree. You can use a WeakHashMap in conjunction with a retention strategy. It depends if you have a retention strategy.

I didn't have time to create my little example but I will...</pre>
    </div>

    <div id="c12" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c12">Comment 12</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-15 07:17:59 EST
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=209490#c10">comment #10</a>)
<span class="quote">&gt; Committed to CVS.
&gt; Simon: Can you please have a look if you like the current implementation of
&gt; ReferenceValueMap?</span >

Yes it will be great... It was also my thought but from that post
<a class="bz_bug_link 
          bz_status_CLOSED  bz_closed"
   title="CLOSED FIXED - Limit memory consumption in CDORevisionResolverImpl"
   href="show_bug.cgi?id=203538">https://bugs.eclipse.org/bugs/show_bug.cgi?id=203538</a>
you said &quot;that soft references behave different from weak ones&quot;. Do we think it is still a valid argument ?

*************
<span class="quote">&gt; If I resume, what will work well.. is to put WeakReference in the
&gt; CDORevisionResolver. The Cache should have a SoftReference...</span >
I've read somewhere that Sun's JVM spec doesn't force implementations to really
make soft references behave different from weak ones! If, for example, you use
a hotspot vm in client mode soft refs are getting cleared at next gc, too
(given they are softly reachable).
***************</pre>
    </div>

    <div id="c13" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c13">Comment 13</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-15 07:20:10 EST
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=209490#c11">comment #11</a>)
<span class="quote">&gt; (In reply to <a href="show_bug.cgi?id=209490#c9">comment #9</a>)
&gt; &gt; One note to the usage of WeakHashMap: I don't think that we can use such to
&gt; &gt; implement a meory sensitive cache of InteralCDOObjects. We need a Map with weak
&gt; &gt; (better soft) refs to the values and not to the keys. Agreed?
&gt; I do not agree. You can use a WeakHashMap in conjunction with a retention
&gt; strategy. It depends if you have a retention strategy.
&gt; I didn't have time to create my little example but I will...</span >

Maybe  I didn't understand ?
Why not garbage collect the key ? 
</pre>
    </div>

    <div id="c14" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c14">Comment 14</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-15 08:05:50 EST
        </span>

      </div>




<pre class="bz_comment_text">The keys are of type CDOID. They are much like value objects, we can have different id objects referring to the same InternalCDOObject.

Another reason: the revisons use CDOIDs to &quot;unconnect&quot; the revision graph. using the keys (ids) as WeakReferences would prevent CDOObjects from being purged if other revisions use their ids but the application does not.

With respect to the soft/weak discussion: you're right, weak ones seem better here.</pre>
    </div>

    <div id="c15" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c15">Comment 15</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-11-25 17:33:57 EST
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=209490#c14">comment #14</a>)
<span class="quote">&gt; The keys are of type CDOID. They are much like value objects, we can have
&gt; different id objects referring to the same InternalCDOObject.
&gt; Another reason: the revisons use CDOIDs to &quot;unconnect&quot; the revision graph.
&gt; using the keys (ids) as WeakReferences would prevent CDOObjects from being
&gt; purged if other revisions use their ids but the application does not.
&gt; With respect to the soft/weak discussion: you're right, weak ones seem better
&gt; here.</span >

 You are right about the WeakHashMap.

About your Implementation Of ReferenveValueMap... seems really good. Didn`t test it but I see where you are going.
I will test that capability very soon!!</pre>
    </div>

    <div id="c16" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c16">Comment 16</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-17 03:00:38 EST
        </span>

      </div>




<pre class="bz_comment_text">Fix: Remove enqueued ReferenceValueMap entries on read access.</pre>
    </div>

    <div id="c17" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c17">Comment 17</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-18 02:39:46 EST
        </span>

      </div>




<pre class="bz_comment_text">Copied from <a class="bz_bug_link 
          bz_status_CLOSED  bz_closed"
   title="CLOSED FIXED - Put purging mechanism in CDOViewIMpl::objects to avoid OutOfMemory"
   href="show_bug.cgi?id=209490">bug #209490</a> (Simon):

<span class="quote">&gt; &gt; In the demo setup (derby client mode db, cdo server, 2 cdo clients) I observed a
&gt; &gt; problem with the first update to a transaction: The second client doesn't
&gt; &gt; reflect the change.
&gt; This seems to result from my changes for <a class="bz_bug_link 
          bz_status_CLOSED  bz_closed"
   title="CLOSED FIXED - Put purging mechanism in CDOViewIMpl::objects to avoid OutOfMemory"
   href="show_bug.cgi?id=209490">bug #209490</a> .
&gt; My setup seemed to be low on memory and sent some objects of the view to a
&gt; reference queue (clearing the references). But the references didn't get purged
&gt; from the map until the next write access. Now also read access will either
&gt; purge the whole map (size, isEmpty) or at least test the references
&gt; (containsKey). This seems to fix the bug.</span >

I try to understand what you find.. and I'm not sure what happens ??

Are we going to have a problem in an application where we will be high in memory ? 

It should work even with the weak.. right ? 

Before removing from the queue... should  we not check if the value in the map is null ? (with a syncrhonized where we add/remove/purge.

  protected void purgeQueue()
  {
    if (queue != null)
    {
      synchronized(..)
      {
         KeyedReference&lt;K, V&gt; ref;
         while ((ref = (KeyedReference&lt;K, V&gt;)queue.poll()) != null)
         { 
           &gt;&gt; SHOULD CHECK!!!!
           if (map.get(ref.getKey()) == ref)
              map.remove(ref.getKey());
         }
      }

    }
  }</pre>
    </div>

    <div id="c18" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c18">Comment 18</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-18 03:17:24 EST
        </span>

      </div>




<pre class="bz_comment_text">ReferenceValueMap has only 2 revisions in CVS. Compare them to see my recent fix. The first version called purgeQueue() only when the map gets modified (put, remove, ...). On read access (containsKey, size, ...) nothing was done, so containsKey could return true even if the ref was enqueued (cleared).

Now I do one of two things on read access:
1) for multi-read (size, isEmpty, clear) I call purgeQueue() before the read.
2) for single-read (containsKey) I test the reference for being enqueued after the read.

To your proposal in purgeQueue (&gt;&gt; SHOULD CHECK!!!!):
For soft and weak references there are two indications that the target is no longer reachable:
a) ref gets cleared
b) ref gets enqueued
In fact I thought b) is a stronger statement about unreachability but that's wrong. First the ref gets cleared, a).

I think in purgeQueue we don't need to check anthing, the existance of a ref within the queue indicates that for sure the ref is also cleared. We could be more eager by iterating the map instead of the queue and testing for cleared refs but the effort is to high, that's what the refqueues are for.

On the other hand for read access I now believe that it'd be better to check for cleared refs instead of for enqueued refs (enqueuing might be delayed).

To weak/soft refs:
I changed the ref type from weak to soft. Although on client side this makes no difference by default (Sun VMs) I think my basic assumption that caused this change was also wrong. I thought the CDOObject could be reused (and thus be kept longer with a soft ref) but that seems very unprobable (other than with revisions).

All this leads to 3 new changes:
A) Check for cleared refs on read-access
B) Change back from soft to weak
3) Add proper synchronization

Agreed?</pre>
    </div>

    <div id="c19" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c19">Comment 19</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-18 04:09:40 EST
        </span>

      </div>




<pre class="bz_comment_text">One more change with respect to synchronization:
I'll put a comment in the header of ReferenceValueMap: &quot;This Map is not synchronized, if it is to be used by multiple threads concurrently you'll have to add proper synchronization yourself!&quot;

Since the map itself doesn't implement own multi threading synchronization is not really needed in the multi purpose implementation.</pre>
    </div>

    <div id="c20" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c20">Comment 20</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-18 07:20:35 EST
        </span>

      </div>




<pre class="bz_comment_text"><span class="quote">&gt; All this leads to 3 new changes:
&gt; A) Check for cleared refs on read-access
&gt; B) Change back from soft to weak
&gt; 3) Add proper synchronization
&gt; Agreed?</span >


I look at your modification.

Let say we are in this following state :

ReferenceValueQueue
A is in the queue and in the map.
We add A' in the map.(A' replace A)
we call purgeQueue.

PurgeQueue get A and will remove A' since we replace A by A'.

Is this possible ?



</pre>
    </div>

    <div id="c21" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c21">Comment 21</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-18 07:33:53 EST
        </span>

      </div>




<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=85455" name="attach_85455" title="a testcase to show the problem.">attachment 85455</a> <a href="attachment.cgi?id=85455&amp;action=edit" title="a testcase to show the problem.">[details]</a></span>
a testcase to show the problem.</pre>
    </div>

    <div id="c22" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c22">Comment 22</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-18 07:41:10 EST
        </span>

      </div>




<pre class="bz_comment_text">Created <span class=""><a href="attachment.cgi?id=85456" name="attach_85456" title="2 test cases plus a fix to show the fix">attachment 85456</a> <a href="attachment.cgi?id=85456&amp;action=edit" title="2 test cases plus a fix to show the fix">[details]</a></span>
2 test cases plus a fix to show the fix</pre>
    </div>

    <div id="c23" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c23">Comment 23</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-18 08:21:14 EST
        </span>

      </div>




<pre class="bz_comment_text">I fact we should never enqueue ourself..

enqueue in containsKey and containesValue should be removed as well

containsKey
containsValue

</pre>
    </div>

    <div id="c24" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c24">Comment 24</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-18 10:06:45 EST
        </span>

      </div>




<pre class="bz_comment_text"> (In reply to <a href="show_bug.cgi?id=209490#c20">comment #20</a>, <a href="show_bug.cgi?id=209490#c21">comment #21</a>, <a href="show_bug.cgi?id=209490#c22">comment #22</a>, <a href="show_bug.cgi?id=209490#c23">comment #23</a>)

Your fix seems to workaround the problem of removing the wrong value by simply not removing it, right?
I don't like that very much but I must, after various attempts, admit that I don't see a better solution.

Committed to CVS.

</pre>
    </div>

    <div id="c25" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c25">Comment 25</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-18 10:10:43 EST
        </span>

      </div>




<pre class="bz_comment_text">Have we ever tried to not only add the key to the Reference but also the value (referent)?
This could be (if it works) a second solution because it would enable to call map.remove(ref.key, ref.value).

But more interesting, it could even solve the problem of memory sensitive caches with eviction policy!
I'll hack a prototype...
</pre>
    </div>

    <div id="c26" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c26">Comment 26</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Simon Mc Duff</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=smcduff&#64;hotmail.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=smcduff&#64;hotmail.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-18 10:27:15 EST
        </span>

      </div>




<pre class="bz_comment_text">(In reply to <a href="show_bug.cgi?id=209490#c24">comment #24</a>)
<span class="quote">&gt;  (In reply to <a href="show_bug.cgi?id=209490#c20">comment #20</a>, <a href="show_bug.cgi?id=209490#c21">comment #21</a>, <a href="show_bug.cgi?id=209490#c22">comment #22</a>, <a href="show_bug.cgi?id=209490#c23">comment #23</a>)
&gt; Your fix seems to workaround the problem of removing the wrong value by simply
&gt; not removing it, right?
&gt; I don't like that very much but I must, after various attempts, admit that I
&gt; don't see a better solution.
&gt; Committed to CVS.</span >

I don't remove it because it was already replaced by something else. (put or replace)
I don't see it as a workaround since when you replace it.. you cannot do anything to fix the problem at this point.

</pre>
    </div>

    <div id="c27" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c27">Comment 27</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-18 10:53:42 EST
        </span>

      </div>




<pre class="bz_comment_text"> (In reply to <a href="show_bug.cgi?id=209490#c26">comment #26</a>)
<span class="quote">&gt; I don't see it as a workaround since when you replace it.. you cannot do
&gt; anything to fix the problem at this point.</span >

Sorry, just a glitch-through after dozen or so changes to that comment ;-)</pre>
    </div>

    <div id="c28" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c28">Comment 28</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2007-12-18 11:13:42 EST
        </span>

      </div>




<pre class="bz_comment_text"> (In reply to <a href="show_bug.cgi?id=209490#c25">comment #25</a>)
<span class="quote">&gt; But more interesting, it could even solve the problem of memory sensitive caches
&gt; with eviction policy!
&gt; I'll hack a prototype...</span >

It didn't work. It seems that the strong ref inside the WeakRef prevents the WeakRef from being enqueued ;-(
Only if yuo have time and fun you could take a look at org.eclipse.net4j.util.tests.cache.SensitiveProtoTest ...</pre>
    </div>

    <div id="c29" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c29">Comment 29</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-01-04 12:21:34 EST
        </span>

      </div>




<pre class="bz_comment_text">Fixed in I200801030620</pre>
    </div>

    <div id="c30" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c30">Comment 30</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Nick Boldt</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=nboldt&#64;redhat.com" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=nboldt&#64;redhat.com" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-01-28 16:44:48 EST
        </span>

      </div>




<pre class="bz_comment_text">Move to verified as per <a class="bz_bug_link 
          bz_status_VERIFIED  bz_closed"
   title="VERIFIED FIXED - Switch UpdateBugStateTask to use FIXED -&gt; VERIFIED"
   href="show_bug.cgi?id=206558">bug 206558</a>.</pre>
    </div>

    <div id="c31" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c31">Comment 31</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-06-10 02:29:17 EDT
        </span>

      </div>




<pre class="bz_comment_text">Reversioned due to graduation</pre>
    </div>

    <div id="c32" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=209490#c32">Comment 32</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Eike Stepper</span> <a href="http://wiki.eclipse.org/ECA"><img class="cla_dec" src="https://accounts.eclipse.org/user/eca/badge?mail=stepper&#64;esc-net.de" alt="CLA" title="Eclipse Contributor Agreement" /></a> <a href="https://eclipse.org/donate/"><img class="cla_dec" src="//www.eclipse.org/donate/web-api/friends_decorator.php?email=stepper&#64;esc-net.de" alt="Friend" title="Friend of Eclipse" /></a>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-09-11 13:49:13 EDT
        </span>

      </div>




<pre class="bz_comment_text">CLOSING</pre>
    </div>


  

</td>
<td>
</td>
</tr></table>
  </div>
        

</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=209490">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=209490">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=209490">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>

<br>
</div>

    <div id="footer">
      <div class="intro"></div>
<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_bottom" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_bottom");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch" 
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search" 
           id="find_bottom"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li>
      <span class="separator">| </span>
        <a href="request.cgi">Requests</a></li>


  <li>
        <span class="separator">| </span>
        <a href="https://bugzilla.readthedocs.org/en/5.0/using/understanding.html" target="_blank">Help</a>
      </li>
    

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="show_bug.cgi?id=209490&amp;GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>

  <form action="show_bug.cgi?id=209490" method="POST"
        class="mini_login bz_default_hidden"
        id="mini_login_bottom">
    <input id="Bugzilla_login_bottom" required
           name="Bugzilla_login" class="bz_login"
        placeholder="Login">
    <input class="bz_password" name="Bugzilla_password" type="password"
           id="Bugzilla_password_bottom" required
           placeholder="Password">
    <input type="hidden" name="Bugzilla_login_token"
           value="">
    <input type="submit" name="GoAheadAndLogIn" value="Log in"
            id="log_in_bottom">
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>
  <span class="separator">| </span>
  <li><a href="http://www.eclipse.org/legal/termsofuse.php">Terms of Use</a></li>
  <span class="separator">| </span>
  <li><a href="http://www.eclipse.org/legal/copyright.php">Copyright Agent</a></li>
</ul>
  </li>

  




  
</ul>

      <div class="outro"></div>
    </div>

  </body>
</html>